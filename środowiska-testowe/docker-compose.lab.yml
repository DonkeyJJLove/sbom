name: sbom-lab

x-aid-env: &aid-env
  AID_APP_ID: ${AID_APP_ID:-sbom}
  AID_OWNER_TEAM: ${AID_OWNER_TEAM:-K82M}
  AID_ENV: ${AID_ENV:-lab}
  AID_VCS_REF: ${AID_VCS_REF:-local}
  AID_APP_VERSION: ${AID_APP_VERSION:-0.0.0}
  AID_REPO: ${AID_REPO:-DonkeyJJLove/sbom}

# Wspólne zmienne LAB (obecne niezależnie od backendu; pipeline wybierze docelowy kanał)
x-lab-env: &lab-env
  <<: *aid-env
  TZ: Europe/Warsaw
  ES_URL: "http://elasticsearch:9200"
  ES_INDEX: ${ES_INDEX:-sbom-test}
  SPLUNK_HEC_URL: "http://splunk:8088/services/collector/event"
  SPLUNK_HEC_TOKEN: ${SPLUNK_HEC_TOKEN:-00000000-0000-0000-0000-000000000000}

# Elasticsearch env (backend "elastic")
x-es-env: &es-env
  discovery.type: single-node
  xpack.security.enabled: "${ES_SECURITY_ENABLED:-false}"
  xpack.security.enrollment.enabled: "false"
  ES_JAVA_OPTS: ${ES_JAVA_OPTS:--Xms1g -Xmx1g}

# Docker.sock access (WSL: /var/run/docker.sock -> group docker, GID=1000, mode 660)
x-docker-access: &docker-access
  group_add:
    - "1000"

services:
  # UI/panel LAB (opcjonalny, ale wygodny)
  portainer:
    <<: *docker-access
    image: portainer/portainer-ce:latest
    container_name: sbom-lab-portainer
    ports:
      - "9000:9000"
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock
      - portainer_data:/data
    restart: unless-stopped
    networks: [mgmt]

  # CORE: toolbox + jenkins zawsze (backend wybierasz profilem)
  toolbox:
    <<: *docker-access
    build:
      context: ../lab/toolbox
      dockerfile: Dockerfile
    image: sbom-lab/toolbox:latest
    container_name: sbom-lab-toolbox
    command: ["bash","-lc","sleep infinity"]
    stdin_open: true
    tty: true
    environment:
      <<: *lab-env
    volumes:
      - type: bind
        source: ..
        target: /repo
      - type: bind
        source: ./out
        target: /lab/out
      - /var/run/docker.sock:/var/run/docker.sock
    restart: unless-stopped
    networks: [ci, mgmt]

  jenkins:
    <<: *docker-access
    build:
      context: ../lab/jenkins
      dockerfile: Dockerfile
    container_name: sbom-lab-jenkins
    environment:
      <<: *lab-env
    ports:
      - "8080:8080"
      - "50000:50000"
    volumes:
      - jenkins_home:/var/jenkins_home
      - /var/run/docker.sock:/var/run/docker.sock
      - type: bind
        source: ..
        target: /repo
    restart: unless-stopped
    networks: [ci, mgmt]

  # BACKEND A: Elastic + Kibana (profil "elastic")
  elasticsearch:
    image: docker.elastic.co/elasticsearch/elasticsearch:8.12.2
    container_name: sbom-lab-elasticsearch
    profiles: ["elastic"]
    environment:
      <<: *es-env
    ports:
      - "9200:9200"
    volumes:
      - es_data:/usr/share/elasticsearch/data
    ulimits:
      memlock: { soft: -1, hard: -1 }
      nofile:  { soft: 65536, hard: 65536 }
    restart: unless-stopped
    networks: [mgmt, ci]
    healthcheck:
      # działa gdy security OFF; przy ON dołożymy auth w następnym kroku refaktoru
      test: ["CMD-SHELL", "curl -fsS http://localhost:9200 >/dev/null || exit 1"]
      interval: 10s
      timeout: 5s
      retries: 30

  kibana:
    image: docker.elastic.co/kibana/kibana:8.12.2
    container_name: sbom-lab-kibana
    profiles: ["elastic"]
    environment:
      ELASTICSEARCH_HOSTS: "http://elasticsearch:9200"
    ports:
      - "5601:5601"
    depends_on:
      elasticsearch:
        condition: service_healthy
    restart: unless-stopped
    networks: [mgmt]
    healthcheck:
      test: ["CMD-SHELL", "curl -fsS http://localhost:5601/api/status >/dev/null || exit 1"]
      interval: 15s
      timeout: 5s
      retries: 40

  # BACKEND B: Splunk (profil "splunk")
  splunk:
    image: splunk/splunk:9.2.1
    container_name: sbom-lab-splunk
    profiles: ["splunk"]
    hostname: splunk
    environment:
      SPLUNK_START_ARGS: "--accept-license"
      SPLUNK_PASSWORD: ${SPLUNK_PASSWORD:-ChangeMe_Strong_Password_1!}
      SPLUNK_LICENSE_URI: "Free"
      TZ: Europe/Warsaw
      SPLUNK_HEC_TOKEN: ${SPLUNK_HEC_TOKEN:-00000000-0000-0000-0000-000000000000}
      SPLUNK_HEC_ENABLE: "true"
      SPLUNK_HEC_SSL: "false"
      SPLUNK_HEC_PORT: "8088"
    ports:
      - "8000:8000"
      - "8088:8088"
      - "8089:8089"
    volumes:
      - splunk_etc:/opt/splunk/etc
      - splunk_var:/opt/splunk/var
      - ./splunk-app-sbom:/opt/splunk/etc/apps/sbom_app:rw
    healthcheck:
      test: ["CMD", "bash", "-lc", "curl -fsS http://localhost:8088/services/collector/health | grep -q healthy"]
      interval: 20s
      timeout: 10s
      retries: 60
      start_period: 420s
    restart: unless-stopped
    networks: [mgmt, ci]

networks:
  mgmt: {}
  ci: {}

volumes:
  portainer_data: {}
  jenkins_home: {}
  es_data: {}
  splunk_etc: {}
  splunk_var: {}
