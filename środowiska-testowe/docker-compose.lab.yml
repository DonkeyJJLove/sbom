name: sbom-lab

x-aid-env: &aid-env
  AID_APP_ID: ${AID_APP_ID:-sbom}
  AID_OWNER_TEAM: ${AID_OWNER_TEAM:-K82M}
  AID_ENV: ${AID_ENV:-lab}
  AID_VCS_REF: ${AID_VCS_REF:-local}
  AID_APP_VERSION: ${AID_APP_VERSION:-0.0.0}
  AID_REPO: ${AID_REPO:-DonkeyJJLove/sbom}

x-es-env: &es-env
  discovery.type: single-node
  xpack.security.enabled: "false"
  xpack.security.enrollment.enabled: "false"
  ES_JAVA_OPTS: ${ES_JAVA_OPTS:--Xms1g -Xmx1g}

services:
  portainer:
    image: portainer/portainer-ce:latest
    container_name: sbom-lab-portainer
    ports:
      - "9000:9000"
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock
      - portainer_data:/data
    restart: unless-stopped
    networks: [mgmt]

  elasticsearch:
    image: docker.elastic.co/elasticsearch/elasticsearch:8.12.2
    container_name: sbom-lab-elasticsearch
    environment:
      <<: *es-env
    ports:
      - "9200:9200"
    volumes:
      - es_data:/usr/share/elasticsearch/data
    ulimits:
      memlock: { soft: -1, hard: -1 }
      nofile:  { soft: 65536, hard: 65536 }
    restart: unless-stopped
    networks: [mgmt, ci]
    healthcheck:
      test: ["CMD-SHELL", "curl -fsS http://localhost:9200 >/dev/null || exit 1"]
      interval: 10s
      timeout: 5s
      retries: 30

  kibana:
    image: docker.elastic.co/kibana/kibana:8.12.2
    container_name: sbom-lab-kibana
    environment:
      ELASTICSEARCH_HOSTS: "http://elasticsearch:9200"
    ports:
      - "5601:5601"
    depends_on:
      elasticsearch:
        condition: service_healthy
    restart: unless-stopped
    networks: [mgmt]
    healthcheck:
      test: ["CMD-SHELL", "curl -fsS http://localhost:5601/api/status >/dev/null || exit 1"]
      interval: 15s
      timeout: 5s
      retries: 40

  toolbox:
    build:
      context: ../lab/toolbox
      dockerfile: Dockerfile
    image: sbom-lab/toolbox:latest
    container_name: sbom-lab-toolbox
    command: ["bash","-lc","sleep infinity"]
    stdin_open: true
    tty: true
    environment:
      <<: *aid-env
      ES_URL: "http://elasticsearch:9200"
      ES_INDEX: ${ES_INDEX:-sbom-test}
    volumes:
      # root repo do /repo (ważne: source=.. bo compose jest w środowiska-testowe/)
      - type: bind
        source: ..
        target: /repo
      # katalog wynikowy LAB
      - type: bind
        source: ./out
        target: /lab/out
      # jeśli chcesz, żeby toolbox mógł uruchamiać docker (np. skanować obrazy)
      - /var/run/docker.sock:/var/run/docker.sock
    depends_on:
      elasticsearch:
        condition: service_healthy
    restart: unless-stopped
    networks: [ci, mgmt]

  jenkins:
    build:
      context: ../lab/jenkins
      dockerfile: Dockerfile
    container_name: sbom-lab-jenkins
    environment:
      <<: *aid-env
      ES_URL: "http://elasticsearch:9200"
      ES_INDEX: ${ES_INDEX:-sbom-test}
    ports:
      - "8080:8080"
      - "50000:50000"
    volumes:
      - jenkins_home:/var/jenkins_home
      # docker socket, żeby Jenkins mógł robić docker run toolbox (najprościej)
      - /var/run/docker.sock:/var/run/docker.sock
      # root repo do /repo w Jenkinsie (żeby pipeline miał stałą ścieżkę)
      - type: bind
        source: ..
        target: /repo
    depends_on:
      elasticsearch:
        condition: service_healthy
      kibana:
        condition: service_healthy
    restart: unless-stopped
    networks: [ci, mgmt]

networks:
  mgmt: {}
  ci: {}

volumes:
  portainer_data: {}
  jenkins_home: {}
  es_data: {}
