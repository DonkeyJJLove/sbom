# docker-compose.lab.yml  (ROOT repo)
version: "3.9"
name: sbom-lab

x-aid-env: &aid-env
  AID_APP_ID: ${AID_APP_ID:-sbom}
  AID_OWNER_TEAM: ${AID_OWNER_TEAM:-AKMF}
  AID_ENV: ${AID_ENV:-lab}
  AID_VCS_REF: ${AID_VCS_REF:-local}
  AID_APP_VERSION: ${AID_APP_VERSION:-0.0.0}
  AID_REPO: ${AID_REPO:-DonkeyJJLove/sbom}
  SPLUNK_INDEX_SBOM: ${SPLUNK_INDEX_SBOM:-sbom}

services:
  portainer:
    image: portainer/portainer-ce:latest
    container_name: sbom-lab-portainer
    ports: ["9000:9000"]
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock
      - portainer_data:/data
    restart: unless-stopped
    networks: [mgmt]

  splunk:
    image: splunk/splunk:latest
    container_name: sbom-lab-splunk
    environment:
      <<: *aid-env
      SPLUNK_START_ARGS: "--accept-license"
      SPLUNK_PASSWORD: "${SPLUNK_PASSWORD:-Changeme1!}"
      SPLUNK_HEC_ENABLE: "1"
      SPLUNK_HEC_TOKEN: "${SPLUNK_HEC_TOKEN:-11111111-1111-1111-1111-111111111111}"
    ports:
      - "8000:8000"
      - "8088:8088"
      - "8089:8089"
    volumes:
      - splunk_etc:/opt/splunk/etc
      - splunk_var:/opt/splunk/var
    restart: unless-stopped
    networks: [sec, mgmt]

  jenkins:
    build:
      context: ./lab/jenkins
      dockerfile: Dockerfile
    container_name: sbom-lab-jenkins
    environment:
      <<: *aid-env
    ports:
      - "8080:8080"
      - "50000:50000"
    volumes:
      - jenkins_home:/var/jenkins_home
      - /var/run/docker.sock:/var/run/docker.sock
    restart: unless-stopped
    networks: [ci, mgmt]

  toolbox1:
    build:
      context: ./lab/toolbox
      dockerfile: Dockerfile
    container_name: sbom-lab-toolbox1
    command: ["bash","-lc","sleep infinity"]
    stdin_open: true
    tty: true
    environment:
      <<: *aid-env
      SPLUNK_HEC_EVENT_URL: "http://splunk:8088/services/collector/event"
      SPLUNK_HEC_TOKEN: "${SPLUNK_HEC_TOKEN:-11111111-1111-1111-1111-111111111111}"
    volumes:
      - type: bind
        source: .
        target: /repo
      - type: bind
        source: ./lab/out
        target: /lab/out
      - /var/run/docker.sock:/var/run/docker.sock
    networks: [ci, sec]

  toolbox2:
    extends: { service: toolbox1 }
    container_name: sbom-lab-toolbox2

  toolbox3:
    extends: { service: toolbox1 }
    container_name: sbom-lab-toolbox3

  toolbox4:
    extends: { service: toolbox1 }
    container_name: sbom-lab-toolbox4

networks:
  mgmt: {}
  ci: {}
  sec: {}

volumes:
  portainer_data: {}
  splunk_etc: {}
  splunk_var: {}
  jenkins_home: {}
