# docker-compose.splunk.yml (wariant BACKEND: Splunk)
# Cel: ten plik NIE dubluje LAB (Jenkins/toolbox/portainer).
# Dokłada tylko Splunka + nadpisuje/uzupełnia env w usługach bazowych (jenkins, toolbox).
#
# Uruchomienie (po refaktorze bazowego LAB):
#   docker compose -f docker-compose.base.yml -f docker-compose.splunk.yml up -d
#
# Uwaga: w tym wariancie Splunk i Elastic są ALTERNATYWAMI — uruchamiasz tylko jeden backend na raz.

services:
  splunk:
    image: splunk/splunk:9.2.1
    container_name: sbom-lab-splunk
    hostname: splunk
    environment:
      SPLUNK_START_ARGS: "--accept-license"
      SPLUNK_PASSWORD: ${SPLUNK_PASSWORD:-ChangeMe_Strong_Password_1!}
      SPLUNK_LICENSE_URI: "Free"
      TZ: Europe/Warsaw

      # HEC (ingest z Jenkins/toolbox)
      SPLUNK_HEC_TOKEN: ${SPLUNK_HEC_TOKEN:-00000000-0000-0000-0000-000000000000}
      SPLUNK_HEC_ENABLE: "true"

      # PoC/LAB: HEC po HTTP (łatwiejszy debug). PROD: ustaw true + certy.
      SPLUNK_HEC_SSL: "false"
      SPLUNK_HEC_PORT: "8088"
    ports:
      - "8000:8000"   # Splunk Web
      - "8088:8088"   # HEC
      - "8089:8089"   # Mgmt (opcjonalnie)
    volumes:
      - splunk_etc:/opt/splunk/etc
      - splunk_var:/opt/splunk/var
      # aplikacja/konfiguracja SBOM (parsery, sourcetype, dashboardy) — katalog w ścieżce tego compose
      - ./splunk-app-sbom:/opt/splunk/etc/apps/sbom_app:rw
    healthcheck:
      test: ["CMD", "bash", "-lc", "curl -fsS http://localhost:8088/services/collector/health | grep -q healthy"]
      interval: 20s
      timeout: 10s
      retries: 60
      start_period: 420s
    restart: unless-stopped
    networks: [mgmt, ci]

  # UZUPEŁNIENIA dla LAB-core:
  # - ten blok zakłada, że w bazowym pliku istnieje usługa "jenkins"
  jenkins:
    environment:
      SPLUNK_HEC_URL: "http://splunk:8088/services/collector/event"
      SPLUNK_HEC_TOKEN: ${SPLUNK_HEC_TOKEN:-00000000-0000-0000-0000-000000000000}
    depends_on:
      splunk:
        condition: service_healthy

  # - ten blok zakłada, że w bazowym pliku istnieje usługa "toolbox"
  toolbox:
    environment:
      SPLUNK_HEC_URL: "http://splunk:8088/services/collector/event"
      SPLUNK_HEC_TOKEN: ${SPLUNK_HEC_TOKEN:-00000000-0000-0000-0000-000000000000}
    depends_on:
      splunk:
        condition: service_healthy

volumes:
  splunk_etc: {}
  splunk_var: {}
